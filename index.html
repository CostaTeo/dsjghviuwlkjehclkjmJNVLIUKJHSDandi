<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saldi Gruppo - Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .progress-deadline {
            font-size: 0.85em;
            color: #999;
            font-style: italic;
        }

        .progress-amount {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
            flex: 1;
        }

        .progress-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.5s ease;
        }

        .progress-percentage {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1em;
            white-space: nowrap;
            min-width: 50px;
        }

        .progress-target {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 0.95em;
        }

        .monthly-target {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .monthly-item {
            text-align: center;
        }

        .monthly-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .monthly-label {
            font-size: 0.85em;
            color: #666;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .member-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .member-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .member-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
        }

        .member-balance {
            font-size: 1.3em;
            font-weight: 700;
        }

        .balance-positive {
            color: #2ecc71;
        }

        .balance-negative {
            color: #e74c3c;
        }

        .balance-zero {
            color: #95a5a6;
        }

        .balance-neutral {
            color: #7f8c8d;
        }

        .member-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
        }

        button:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px 15px;
            }

            header h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 15px;
            }

            .progress-section {
                padding: 15px;
                margin-bottom: 20px;
            }

            .progress-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .progress-amount {
                font-size: 1.1em;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .member-card {
                padding: 15px;
            }

            .monthly-target {
                flex-direction: column;
                gap: 10px;
            }

            .monthly-item {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }

            .monthly-label {
                text-align: right;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Fondo Studi Alice & Lilia</h1>
            <p class="subtitle" id="timestamp"></p>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Caricamento dati in corso...</p>
        </div>

        <div id="content" class="content" style="display: none;">
            <button onclick="location.reload()">üîÑ Aggiorna</button>
            
            <div class="progress-section">
                <div class="progress-header">
                    <div>
                        <div class="progress-title">üéØ Obiettivo</div>
                        <div class="progress-deadline">Scadenza: Gennaio 2035</div>
                    </div>
                    <div class="progress-amount" id="progressAmount">‚Ç¨0 / ‚Ç¨15.000</div>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                </div>
                <div class="progress-target" id="progressRemaining">Mancano ‚Ç¨15.000 all'obiettivo</div>
                <div class="monthly-target">
                    <div class="monthly-item">
                        <div class="monthly-value" id="monthlyAmount">‚Ç¨0</div>
                        <div class="monthly-label">al mese</div>
                    </div>
                    <div class="monthly-item">
                        <div class="monthly-value" id="monthsRemaining">0</div>
                        <div class="monthly-label">mesi rimanenti</div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalContributions">‚Ç¨0</div>
                    <div class="stat-label">Totale Contribuzioni</div>
                </div>
            </div>

            <div id="membersList"></div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ========== CONFIGURAZIONE ==========
        const TARGET_AMOUNT = 15000; // Obiettivo in euro
        const TARGET_DATE = new Date('2035-01-01'); // Data obiettivo
        // ====================================

        // Firebase config (da SettleUp)
        const firebaseConfig = {
            apiKey: "AIzaSyDbf9JS-Mrtbcd25Hff4Pj0yTsg844JovE",
            authDomain: "settle-up-live.firebaseapp.com",
            databaseURL: "https://settle-up-live.firebaseio.com",
            projectId: "settle-up-live",
            storageBucket: "settle-up-live.appspot.com",
            messagingSenderId: "817191222688",
            appId: "1:817191222688:web:6f1f6d1e01f53454aff8c5"
        };

        const GROUP_ID = '-OkUXD0PnOFXTpRFAG8S';

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Calcola i saldi dalle transazioni
        function calculateBalances(members, transactions) {
            const balances = {};
            
            // Inizializza i saldi a 0
            Object.keys(members).forEach(id => {
                balances[id] = 0;
            });

            // Processa ogni transazione
            if (transactions) {
                Object.values(transactions).forEach(transaction => {
                    if (transaction.type === 'expense' && transaction.items) {
                        Object.values(transaction.items).forEach(item => {
                            const amount = parseFloat(item.amount);
                            
                            // Chi ha pagato
                            if (transaction.whoPaid) {
                                Object.values(transaction.whoPaid).forEach(payer => {
                                    balances[payer.memberId] = (balances[payer.memberId] || 0) - amount;
                                });
                            }
                            
                            // Per chi √® la spesa
                            if (item.forWhom) {
                                const numPeople = Object.keys(item.forWhom).length;
                                const amountPerPerson = amount / numPeople;
                                
                                Object.values(item.forWhom).forEach(beneficiary => {
                                    balances[beneficiary.memberId] = (balances[beneficiary.memberId] || 0) + amountPerPerson;
                                });
                            }
                        });
                    }
                });
            }

            return balances;
        }

        // Renderizza i dati
        function renderData(members, balances) {
            const membersArray = Object.entries(members)
                .filter(([id, member]) => member.active)
                .map(([id, member]) => ({
                    id,
                    name: member.name,
                    balance: balances[id] || 0
                }));

            // Separa beneficiari (Alice e Lilia) e contributori (gli altri)
            const beneficiaries = membersArray.filter(m => 
                m.name === 'Alice' || m.name === 'Lilia'
            ).sort((a, b) => b.balance - a.balance);

            const contributors = membersArray.filter(m => 
                m.name !== 'Alice' && m.name !== 'Lilia'
            ).sort((a, b) => b.balance - a.balance);

            // Timestamp
            document.getElementById('timestamp').textContent = 
                'Aggiornato: ' + new Date().toLocaleString('it-IT');

            // Statistiche
            const totalContributions = contributors.reduce((sum, m) => sum + Math.abs(m.balance), 0);
            
            document.getElementById('totalContributions').textContent = '‚Ç¨' + totalContributions.toFixed(2);

            // Progress bar
            const percentage = Math.min((totalContributions / TARGET_AMOUNT) * 100, 100);
            const remaining = Math.max(TARGET_AMOUNT - totalContributions, 0);
            
            document.getElementById('progressAmount').textContent = 
                `‚Ç¨${totalContributions.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.')} / ‚Ç¨${TARGET_AMOUNT.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage.toFixed(1) + '%';
            
            if (remaining > 0) {
                document.getElementById('progressRemaining').textContent = 
                    `Mancano ‚Ç¨${remaining.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.')} all'obiettivo`;
            } else {
                document.getElementById('progressRemaining').textContent = 'üéâ Obiettivo raggiunto!';
            }

            // Calcolo mensile
            const now = new Date();
            const monthsRemaining = Math.max(
                (TARGET_DATE.getFullYear() - now.getFullYear()) * 12 + 
                (TARGET_DATE.getMonth() - now.getMonth()),
                0
            );
            
            document.getElementById('monthsRemaining').textContent = monthsRemaining;
            
            if (monthsRemaining > 0 && remaining > 0) {
                const monthlyNeeded = remaining / monthsRemaining;
                document.getElementById('monthlyAmount').textContent = 
                    '‚Ç¨' + monthlyNeeded.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            } else if (remaining <= 0) {
                document.getElementById('monthlyAmount').textContent = '‚Ç¨0';
            } else {
                document.getElementById('monthlyAmount').textContent = 'N/A';
            }

            // Funzione helper per creare card membro
            const createMemberCard = (member, isBeneficiary) => {
                const bal = Math.abs(member.balance); // Sempre positivo
                const balanceClass = isBeneficiary ? 'balance-positive' : 'balance-neutral';
                const balanceText = `‚Ç¨${bal.toFixed(2)}`;

                return `
                    <div class="member-card">
                        <div class="member-name">${member.name}</div>
                        <div class="member-balance ${balanceClass}">${balanceText}</div>
                    </div>
                `;
            };

            // Renderizza sezioni
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = `
                <div class="section">
                    <h2>üéì Saldo per Universit√†</h2>
                    <div class="members-grid">
                        ${beneficiaries.map(m => createMemberCard(m, true)).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h2>üí∞ Contribuzioni</h2>
                    <div class="members-grid">
                        ${contributors.map(m => createMemberCard(m, false)).join('')}
                    </div>
                </div>
            `;

            // Mostra contenuto
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Carica i dati
        async function loadData() {
            try {
                // Autenticazione anonima
                const userCredential = await signInAnonymously(auth);
                const userId = userCredential.user.uid;
                console.log('‚úÖ Autenticato:', userId);

                // Registra l'inviteHash per accedere al gruppo
                const inviteHashRef = ref(database, `/users/${userId}/inviteLinkHash`);
                await set(inviteHashRef, 'ONMXYoPxpufNTsJ0nNP2');
                console.log('‚úÖ InviteHash registrato');

                // Aspetta un attimo per la propagazione dei permessi
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Carica membri e transazioni
                const membersRef = ref(database, `/members/${GROUP_ID}`);
                const transactionsRef = ref(database, `/transactions/${GROUP_ID}`);

                const [membersSnapshot, transactionsSnapshot] = await Promise.all([
                    get(membersRef),
                    get(transactionsRef)
                ]);

                const members = membersSnapshot.val();
                const transactions = transactionsSnapshot.val();

                if (!members) {
                    throw new Error('Nessun membro trovato');
                }

                // Calcola i saldi
                const balances = calculateBalances(members, transactions || {});

                // Renderizza
                renderData(members, balances);
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 
                    '‚ùå Errore nel caricamento dei dati: ' + error.message;
            }
        }

        // Avvia il caricamento
        loadData();
    </script>
</body>
</html>
